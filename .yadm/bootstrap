#!/bin/bash
# sudo, git, yadm should be installed manually first
bin_exists() {
  command -v $1 >/dev/null 2>&1
}

is_arch () {
  bin_exists pacman
}

is_osx() {
  [ "$(uname -s)" = 'Darwin' ]
}

# args: name [packages]
ins_wrap() {
  local bin=$1
  if [ "$#" -eq 1 ]; then
    local pacs=$1
  else
    local pacs="${*:2}"
  fi
  bin_exists "$bin" || $pacman_install "$pacs"
}

install_common_pac() {
  # vim
  ins_wrap vim
  # Tmux
  ins_wrap tmux
  # ZSH
  ins_wrap zsh
  # jq
  ins_wrap jq
  # ripgrep
  ins_wrap ripgrep
  # fzf
  ins_wrap fzf
}

fetch_url_github_latest_release_binary() {
  local repo=${1}
  local name_pattern=${2}
  curl -s https://api.github.com/repos/${1}/releases/latest \
       | grep "browser_download_url.*${2}" \
       | cut -d : -f 2,3 \
       | tr -d \"
}

if is_osx; then
  pacman_install="brew install"

  # brew
  if [[ ! -f '/usr/local/bin/brew' ]]; then
    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  fi

  # Install common packages
  install_common_pac

  # pip & Powerline
  BREW_PYTHON="/usr/local/bin/python"
  BREW_PIP="/usr/local/bin/pip"
  [[ -f $BREW_PYTHON ]] || $pacman_install python
  which pip > /dev/null || curl https://bootstrap.pypa.io/get-pip.py | $BREW_PYTHON
  $BREW_PIP install powerline-status
  $BREW_PIP install powerline-gitstatus

  # exa
  ins_wrap exa

  # pyenv
  ins_wrap pyenv

  # rbenv
  ins_wrap rbenv

  # fd
  ins_wrap fd

  # ranger
  ins_wrap ranger
else
  # Choose package manager according to distribution
  if is_arch; then
    bin_exists yay || (cd /tmp && git clone https://aur.archlinux.org/yay.git && makepkg -si)
    pacman_install="sudo yay -S --noconfirm"
  else
    pacman_install="sudo apt-get -y install"
  fi

  # Create folders
  [ -d ~/local/log ] || mkdir -p ~/local/log

  # Install common packages
  install_common_pac

  # pip & Powerline
  SYS_PYTHON="/usr/bin/python"
  SYS_PIP="/usr/bin/pip"
  [[ -f $SYS_PYTHON ]] || $pacman_install python
  [[ -f $SYS_PIP ]] || $pacman_install python-pip
  sudo $SYS_PIP install powerline-status
  sudo $SYS_PIP install powerline-gitstatus

  # exa
  if is_arch; then
    ins_wrap exa
  else
    if ! bin_exists exa; then
      tmpf=$(mktemp)
      wget $(fetch_url_github_latest_release_binary ogham/exa linux-x86_64) -O "$tmpf" \
        && unzip "$tmpf" -d ~/local/bin \
        && rm "$tmpf" \
        && mv ~/local/bin/exa-linux-x86_64 ~/local/bin/exa
    fi
  fi

  # Keychain
  ins_wrap keychain

  # fd
  if is_arch; then
    ins_wrap fd fd-rs
  else
    if ! bin_exists fd; then
      tmpf=$(mktemp)
      wget $(fetch_url_github_latest_release_binary sharkdp/fd amd64.deb) -O ${tmpf} \
        && sudo dpkg -i ${tmpf} \
        && rm ${tmpf}
    fi
  fi

  # ranger
  if is_arch; then
     ins_wrap ranger
  else
    git clone https://github.com/ranger/ranger.git /tmp/ranger \
      && (cd /tmp/ranger && sudo make install)
  fi

  # pyenv
  bin_exists pyenv || git clone https://github.com/pyenv/pyenv.git ~/.pyenv

  # nvm
  bin_exists nvm || git clone https://github.com/creationix/nvm.git ~/.nvm

  # rbenv & ruby-build
  if ! bin_exists rbenv; then
    git clone https://github.com/rbenv/rbenv.git ~/.rbenv
    git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
  fi

  # copyq
  if is_arch; then
    ins_wrap copyq
  fi
fi

# Oh-my-zsh
git clone --recurse-submodules https://github.com/15cm/oh-my-zsh.git ~/.oh-my-zsh

# z
git clone https://github.com/rupa/z.git ~/.z

# vim colors
wget -nc -P ~/.vim/colors https://raw.githubusercontent.com/altercation/vim-colors-solarized/master/colors/solarized.vim
wget -nc -P ~/.vim/colors https://github.com/chriskempson/tomorrow-theme/raw/master/vim/colors/Tomorrow-Night.vim

# tpm
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm

chsh -s "$(command -v zsh)"
